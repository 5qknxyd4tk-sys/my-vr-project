<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KIL ARCHITECTURE WEB STUDIO</title>
    <style>
        :root {
            --brand-color: #AF52DE;
            --bg-glass: rgba(255, 255, 255, 0.82);
            --bg-glass-dark: rgba(255, 255, 255, 0.95);
            --border-light: rgba(0, 0, 0, 0.06);
            --shadow-premium: 0 8px 32px rgba(0, 0, 0, 0.1);
            --font-main: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
        }
        body {
            margin: 0; overflow: hidden; background-color: #e5e5e5; /* 3D Ï∫îÎ≤ÑÏä§ Î∞∞Í≤ΩÏÉâÍ≥º Íµ¨Î∂Ñ */
            font-family: var(--font-main); color: #1d1d1f;
            user-select: none; -webkit-user-select: none;
            -webkit-font-smoothing: antialiased;
        }
        /* Landing Page */
        #landing-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: radial-gradient(circle at center, #ffffff 0%, #f2f2f7 100%);
            z-index: 2000; gap: 40px; transition: opacity 0.3s ease;
        }
        .studio-title { text-align: center; }
        .studio-title h1 {
            margin: 0; font-size: 38px; font-weight: 800; letter-spacing: -0.04em;
            background: linear-gradient(180deg, #1d1d1f 0%, #636366 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .studio-title p { margin-top: 10px; color: var(--brand-color); font-size: 13px; letter-spacing: 0.3em; font-weight: 700; text-transform: uppercase; }
        
        .option-container { display: flex; gap: 24px; flex-wrap: wrap; justify-content: center; }
        .upload-card {
            background: white; border-radius: 32px; padding: 36px; width: 220px;
            text-align: center; cursor: pointer; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid var(--border-light); box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            position: relative;
        }
        .upload-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-premium); border-color: var(--brand-color); }
        .upload-card svg { width: 40px; height: 40px; margin-bottom: 20px; color: var(--brand-color); }
        .upload-card h3 { margin: 0; font-size: 16px; font-weight: 700; }
        
        #loading-status { display: none; color: var(--brand-color); font-weight: 700; font-size: 14px; margin-top: 20px; }

        /* UI Layer */
        #ui-layer { display: none; }
        
        /* Top Bar */
        #top-bar {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            display: flex; align-items: center; gap: 4px; padding: 5px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
            border-radius: 18px; z-index: 1000; box-shadow: var(--shadow-premium);
            border: 1px solid var(--border-light);
            max-width: 95vw; overflow-x: auto;
        }
        button {
            display: inline-flex; align-items: center; gap: 6px;
            background: transparent; border: none; color: #1d1d1f; padding: 8px 12px;
            border-radius: 12px; cursor: pointer; font-size: 11px; font-weight: 700;
            transition: all 0.2s ease; white-space: nowrap;
        }
        button:hover { background: rgba(0,0,0,0.05); }
        button.active { background: var(--brand-color); color: #fff !important; }
        button svg { width: 14px; height: 14px; opacity: 0.8; }
        button.active svg { filter: brightness(0) invert(1); opacity: 1; }
        .divider { width: 1px; height: 14px; background: rgba(0,0,0,0.1); margin: 0 4px; flex-shrink: 0; }

        /* Side Panels */
        #sidebar-left {
            position: absolute; top: 90px; left: 20px;
            display: flex; flex-direction: column; gap: 12px;
            z-index: 100; pointer-events: none;
        }
        .panel {
            width: 210px; pointer-events: auto;
            background: var(--bg-glass); backdrop-filter: blur(30px) saturate(180%);
            border-radius: 16px; box-shadow: var(--shadow-premium);
            border: 1px solid rgba(255,255,255,0.7);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .panel-header {
            padding: 10px 14px; cursor: move; display: flex; justify-content: space-between; align-items: center;
            font-weight: 800; font-size: 9px; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.7;
            background: rgba(0,0,0,0.02);
        }
        .panel-content { padding: 12px 14px; display: flex; flex-direction: column; gap: 10px; }
        .panel.minimized .panel-content { display: none; }
        .toggle-btn { padding: 0; border:none; background:none; cursor: pointer; font-size: 12px; opacity: 0.5; }

        /* Controls */
        .row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .label { color: #86868b; font-size: 9px; font-weight: 800; }
        .btn-group-full { display: flex; flex-direction: column; gap: 6px; width: 100%; }
        .row-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; }
        input[type=range] { -webkit-appearance: none; width: 100%; height: 4px; background: rgba(0,0,0,0.08); border-radius: 2px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: white; border: 1.5px solid var(--brand-color); border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.1); cursor: pointer; }

        /* AI & Toast */
        #ai-response { font-size: 11px; line-height: 1.5; color: #444; background: rgba(0,0,0,0.04); padding: 10px; border-radius: 10px; max-height: 140px; overflow-y: auto; white-space: pre-wrap; }
        #copyright { position: absolute; bottom: 10px; width: 100%; text-align: center; font-size: 8px; color: rgba(0,0,0,0.2); pointer-events: none; }
        #toast { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 20px; border-radius: 15px; opacity: 0; transition: opacity 0.4s; font-size: 12px; z-index: 4000; pointer-events: none; }
        #crosshair { position: absolute; top: 50%; left: 50%; width: 4px; height: 4px; background: var(--brand-color); border-radius: 50%; transform: translate(-50%, -50%); pointer-events: none; display: none; z-index: 1; }
        #help-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.25); backdrop-filter: blur(8px); display: none; justify-content: center; align-items: center; z-index: 3000; }
        .help-content { background: white; width: 340px; padding: 28px; border-radius: 24px; box-shadow: var(--shadow-premium); position: relative; }
        .close-help-btn { position: absolute; top: 20px; right: 20px; cursor: pointer; opacity: 0.5; }
        #VRButton { display: none !important; }

        @media (max-width: 768px) {
            #sidebar-left { display: none; }
            .upload-card { width: 80vw; padding: 24px; }
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>
    <div id="landing-page">
        <div class="studio-title">
            <h1>KIL ARCHITECTURE</h1>
            <p>WEB STUDIO 2026</p>
        </div>
        <div class="option-container">
            <div class="upload-card" id="btn-load-sample">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                <h3>LOAD SAMPLE</h3>
            </div>
            <div class="upload-card" id="btn-trigger-file">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                <h3>BROWSE FILES</h3>
            </div>
            <!-- accept ÏÜçÏÑ±ÏùÑ ÎÑìÌòÄÏÑú Ïù∏Ïãù Î¨∏Ï†ú Ìï¥Í≤∞ -->
            <input type="file" id="file-input" accept=".glb,.gltf,model/gltf-binary" style="display:none;">
        </div>
        <div id="loading-status">INITIALIZING SCENE...</div>
    </div>
    
    <div id="ui-layer">
        <div id="crosshair"></div>
        <div id="top-bar">
            <button id="btn-home" style="color: var(--brand-color); background: rgba(175, 82, 222, 0.1);">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>HOME
            </button>
            <div class="divider"></div>
            <button id="mode-render" class="active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1 4-10z"/><path d="M2 12h20"/></svg>RENDER</button>
            <button id="mode-white"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>WHITE</button>
            <div class="divider"></div>
            <button id="cam-fly" class="active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>FLY</button>
            <button id="cam-walk"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="5" r="3"/><path d="M9 22v-5h6v5"/><path d="M12 8v9"/><path d="M7 11l5-3 5 3"/></svg>WALK</button>
            <button id="cam-iso"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 3l10 5-10 5-10-5z"/><path d="M2 13l10 5 10-5"/><path d="M2 8l10 5 10-5"/></svg>ISO</button>
            <div class="divider"></div>
            <button id="btn-reset"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>RESET</button>
            <button id="btn-vr" style="background:#1d1d1f; color:#fff;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M12 12h.01"/></svg>VR MODE</button>
            <button id="btn-help"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>GUIDE</button>
            <button id="btn-capture" style="color:var(--brand-color)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>CAPTURE</button>
        </div>
        
        <div id="sidebar-left">
            <div id="env-panel" class="panel">
                <div class="panel-header">Environment <button class="toggle-btn" onclick="this.closest('.panel').classList.toggle('minimized')">Ôºç</button></div>
                <div class="panel-content">
                    <div class="btn-group-full"><div class="row-grid"><button id="bg-sky" class="active">SKY</button><button id="bg-solid">SOLID</button><button id="bg-hdr">HDR</button></div></div>
                    <div id="solid-picker-row" style="display:none;" class="row"><span class="label">COLOR</span><input type="color" id="bg-color-val" value="#ffffff" style="border:none;background:none;width:24px;height:24px;cursor:pointer;"></div>
                    <div id="hdr-upload-row" style="display:none;" class="row"><button id="btn-upload-hdr-manual" style="width:100%;background:rgba(0,0,0,0.05);padding:6px;font-size:10px;">UPLOAD HDR</button><input type="file" id="hdr-input" accept=".hdr,.exr" style="display:none;"></div>
                    <div class="row"><span class="label">LINE WEIGHT</span><input type="range" id="toon-weight" min="0" max="5" step="0.1" value="1.5"></div>
                </div>
            </div>
            
            <div id="cut-panel" class="panel">
                <div class="panel-header">Section Analysis <button class="toggle-btn" onclick="this.closest('.panel').classList.toggle('minimized')">Ôºç</button></div>
                <div class="panel-content">
                    <div class="row" style="background:rgba(0,0,0,0.03); padding:6px; border-radius:10px;"><span class="label">SECTION</span><button id="cut-toggle" class="active" style="padding:4px 8px; min-width:60px; font-size:10px;">ON</button></div>
                    <div class="btn-group-full"><div class="row-grid"><button id="axis-x" class="axis-btn">X</button><button id="axis-y" class="axis-btn active">Y</button><button id="axis-z" class="axis-btn">Z</button></div><button id="axis-flip" style="width:100%; background:rgba(175,82,222,0.1); color:var(--brand-color); padding:8px; border-radius:10px; font-size:10px;">REVERSE AXIS</button></div>
                    <div class="row"><span class="label">OFFSET</span><input type="range" id="cut-slider" min="-100" max="100" value="100"></div>
                </div>
            </div>

            <div id="ai-panel" class="panel">
                <div class="panel-header">‚ú® AI Insights <button class="toggle-btn" onclick="this.closest('.panel').classList.toggle('minimized')">Ôºç</button></div>
                <div class="panel-content">
                    <div id="ai-response">Í≥µÍ∞Ñ Î∂ÑÏÑùÏùÑ ÏãúÏûëÌïòÎ†§Î©¥ ÏïÑÎûò Î≤ÑÌäºÏùÑ ÎàÑÎ•¥ÏÑ∏Ïöî.</div>
                    <div class="btn-group-full">
                        <button id="btn-ai-analyze" style="background: var(--brand-color); color: white; padding: 10px; border-radius: 10px; font-size:10px;">
                            ‚ú® ANALYZE VIEW
                        </button>
                        <button id="btn-ai-tts" style="background: rgba(0,0,0,0.05); padding: 8px; border-radius: 10px; font-size:10px; display:none;">
                            üîä AUDIO GUIDE
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="copyright">COPYRIGHT BY KIL ARCHITECTURE 2026</div>
        <div id="toast">Message</div>
    </div>
    
    <div id="help-modal">
        <div class="help-content">
            <div class="close-help-btn" onclick="document.getElementById('help-modal').style.display='none'">‚úï</div>
            <h2 style="margin:0; font-size: 18px; font-weight: 800;">Navigation Guide</h2>
            <div style="font-size: 12px; margin-top: 15px; line-height: 1.6;">
                <b>PC</b>: W/S/A/D Ïù¥Îèô, E/Q ÏÉÅÏäπ/ÌïòÍ∞ï, Space Ï†êÌîÑ/Ï∞©ÏßÄ<br>
                <b>VR</b>: Ïö∞Ï∏° Ï°∞Ïù¥Ïä§Ìã± Ïù¥Îèô, Ìä∏Î¶¨Í±∞ ÌÖîÎ†àÌè¨Ìä∏, B Î≤ÑÌäº Î™®Îìú Ï†ÑÌôò<br>
                <b>AI</b>: ÌòÑÏû¨ Î≥¥Í≥† ÏûàÎäî ÌôîÎ©¥ÏùÑ Î∂ÑÏÑùÌïòÏó¨ Í±¥Ï∂ïÏ†Å ÌÜµÏ∞∞ÏùÑ Ï†úÍ≥µÌï©ÎãàÎã§.
            </div>
        </div>
    </div>
    
    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
        import { VRButton } from 'three/addons/webxr/VRButton.js';
        
        let scene, renderer, perspCamera, orthoCamera, activeCamera, pControls, oControls;
        let cameraRig, model = null, modelGroup = new THREE.Group();
        let originalMaterials = new Map(), envTexture, skyColor = new THREE.Color(0x87CEEB), bgColor = new THREE.Color(0xffffff);
        let sunLight, hemiLight, ambientLight;
        let controllerR, vrTeleportRay;
        let isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        const clipPlane = new THREE.Plane(new THREE.Vector3(0, -1, 0), 100);
        let clipAxis = 'y', clipNegate = true;
        const state = { mode: 'render', cam: 'fly', bg: 'sky', cutEnabled: true };
        const move = { f:0, b:0, l:0, r:0, u:0, d:0 };
        const velocity = new THREE.Vector3();
        let speedMult = 1, isGrounded = false, raycaster = new THREE.Raycaster();
        let isLockPending = false, modelMaxDim = 50;
        const apiKey = "";
        let lastAIAnalysis = "";
        const tempMatrix = new THREE.Matrix4();

        init();

        function init() {
            // 1. Scene Setup
            scene = new THREE.Scene();
            scene.background = skyColor;
            scene.add(modelGroup);

            // 2. Add Grid & Helpers (To ensure visibility immediately)
            const gridHelper = new THREE.GridHelper(500, 50, 0x000000, 0xaaaaaa);
            gridHelper.position.y = -0.1;
            gridHelper.material.opacity = 0.2;
            gridHelper.material.transparent = true;
            scene.add(gridHelper);

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true, alpha: false });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.localClippingEnabled = true;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0;
            renderer.xr.enabled = true;
            document.body.appendChild(renderer.domElement);

            // 4. Cameras
            const aspect = window.innerWidth / window.innerHeight;
            cameraRig = new THREE.Group();
            scene.add(cameraRig);

            perspCamera = new THREE.PerspectiveCamera(60, aspect, 0.1, 20000);
            perspCamera.position.set(50, 50, 50);
            cameraRig.add(perspCamera);

            orthoCamera = new THREE.OrthographicCamera(-50*aspect, 50*aspect, 50, -50, 0.1, 20000);
            orthoCamera.position.set(50, 50, 50);
            orthoCamera.lookAt(0,0,0);

            activeCamera = perspCamera;

            // 5. Lighting
            ambientLight = new THREE.AmbientLight(0xffffff, 1.2);
            scene.add(ambientLight);
            
            hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.8);
            scene.add(hemiLight);

            sunLight = new THREE.DirectionalLight(0xffffff, 2.5);
            sunLight.position.set(100, 200, 100);
            sunLight.castShadow = true;
            scene.add(sunLight);

            // 6. Environment
            const pmremGenerator = new THREE.PMREMGenerator(renderer);
            envTexture = pmremGenerator.fromScene(new RoomEnvironment(), 0.04).texture;
            scene.environment = envTexture;

            // 7. Controls
            oControls = new OrbitControls(perspCamera, renderer.domElement);
            oControls.enableDamping = true;
            oControls.enabled = true; // Default enabled so user can move immediately

            pControls = new PointerLockControls(perspCamera, document.body);
            pControls.addEventListener('lock', () => { isLockPending = false; document.getElementById('crosshair').style.display = 'block'; oControls.enabled = false; });
            pControls.addEventListener('unlock', () => { isLockPending = false; document.getElementById('crosshair').style.display = 'none'; if(state.cam === 'iso' || isMobile) oControls.enabled = true; });

            // 8. VR
            const vrBtnEl = VRButton.createButton(renderer);
            vrBtnEl.id = "VRButton";
            document.body.appendChild(vrBtnEl);
            controllerR = renderer.xr.getController(1);
            scene.add(controllerR);
            const rayGeo = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,0,0), new THREE.Vector3(0,0,-1)]);
            vrTeleportRay = new THREE.Line(rayGeo, new THREE.LineBasicMaterial({ color: 0xAF52DE, transparent: true, opacity: 0.5 }));
            vrTeleportRay.scale.z = 10;
            controllerR.add(vrTeleportRay);

            // 9. Init Calls
            setupEvents();
            setupUI();
            makePanelsDraggable();
            switchCam('fly');
            animate();
        }

        // --- Loading Logic ---
        function loadGLB(url) {
            const loadingStatus = document.getElementById('loading-status');
            if(loadingStatus) {
                loadingStatus.style.display = 'block';
                loadingStatus.innerText = "SCENE LOADING...";
            }

            // Immediately switch UI to viewer to prevent getting stuck
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';
            
            // Force resize to fix black screen issues on transition
            setTimeout(() => {
                renderer.setSize(window.innerWidth, window.innerHeight);
                const aspect = window.innerWidth / window.innerHeight;
                perspCamera.aspect = aspect;
                perspCamera.updateProjectionMatrix();
            }, 100);

            const loader = new GLTFLoader();
            loader.load(url, (gltf) => {
                onModelLoaded(gltf);
            }, (xhr) => {
                if(loadingStatus) loadingStatus.innerText = `LOADING... ${(xhr.loaded/xhr.total*100).toFixed(0)}%`;
            }, (err) => {
                console.warn("Load failed, using fallback.", err);
                loader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf', (gltf) => {
                    onModelLoaded(gltf);
                    showToast("ÏÉòÌîå Î™®Îç∏Ïù¥ Î°úÎìúÎêòÏóàÏäµÎãàÎã§.");
                });
            });
        }

        function onModelLoaded(gltf) {
            const loadingStatus = document.getElementById('loading-status');
            if(loadingStatus) loadingStatus.style.display = 'none';

            if(model) modelGroup.remove(model);
            model = gltf.scene;

            const box = new THREE.Box3().setFromObject(model);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            modelMaxDim = Math.max(size.x, size.y, size.z) || 10;
            model.position.sub(center);

            model.traverse(c => {
                if(c.isMesh) {
                    c.castShadow = true; c.receiveShadow = true;
                    originalMaterials.set(c.uuid, c.material);
                    applyClipping(c.material);
                    const edges = new THREE.EdgesGeometry(c.geometry, 35);
                    const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.8 }));
                    line.material.clippingPlanes = [clipPlane];
                    line.visible = false;
                    line.userData.isEdge = true;
                    c.add(line);
                }
            });
            modelGroup.add(model);

            // Update Cut Slider
            const slider = document.getElementById('cut-slider');
            if(slider) {
                slider.min = -modelMaxDim;
                slider.max = modelMaxDim;
                slider.value = modelMaxDim;
                updateClipPlane(slider.value);
            }

            // Fit Camera
            const camDist = modelMaxDim * 1.5;
            perspCamera.position.set(camDist, camDist, camDist);
            oControls.target.set(0,0,0);
            oControls.update();
            
            showToast("Workspace Active");
        }

        // --- Core Functions ---
        function applyClipping(m) { if(Array.isArray(m)) m.forEach(x => x.clippingPlanes = [clipPlane]); else m.clippingPlanes = [clipPlane]; }
        function updateClipPlane(val) { const v = parseFloat(val); clipPlane.constant = clipNegate ? v : -v; clipPlane.normal.set(0,0,0); if(clipAxis==='x') clipPlane.normal.x=clipNegate?-1:1; if(clipAxis==='y') clipPlane.normal.y=clipNegate?-1:1; if(clipAxis==='z') clipPlane.normal.z=clipNegate?-1:1; }
        
        function switchCam(mode) {
            state.cam = mode;
            ['cam-fly','cam-walk','cam-iso'].forEach(id => { const el = document.getElementById(id); if(el) el.classList.toggle('active', id === `cam-${mode}`); });
            if(mode === 'iso') { 
                activeCamera = orthoCamera; oControls.object = orthoCamera; oControls.enabled = true; 
                if(document.pointerLockElement) document.exitPointerLock();
            } else { 
                activeCamera = perspCamera; oControls.object = perspCamera; oControls.enabled = isMobile || !document.pointerLockElement; 
                if(document.pointerLockElement) document.exitPointerLock();
            }
        }

        // --- Event Handlers & Input ---
        function setupUI() {
            // Main Button Bindings
            document.getElementById('btn-load-sample').addEventListener('click', () => loadGLB('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/DamagedHelmet/glTF/DamagedHelmet.gltf'));
            
            const fileTrigger = document.getElementById('btn-trigger-file');
            const fileInput = document.getElementById('file-input');
            fileTrigger.addEventListener('click', () => fileInput.click());
            
            fileInput.addEventListener('change', (e) => {
                if(e.target.files && e.target.files[0]) {
                    loadGLB(URL.createObjectURL(e.target.files[0]));
                }
            });

            document.getElementById('btn-home').addEventListener('click', () => location.reload());
            document.getElementById('mode-render').addEventListener('click', () => toggleMode('render'));
            document.getElementById('mode-white').addEventListener('click', () => toggleMode('white'));
            document.getElementById('cam-fly').addEventListener('click', () => switchCam('fly'));
            document.getElementById('cam-walk').addEventListener('click', () => switchCam('walk'));
            document.getElementById('cam-iso').addEventListener('click', () => switchCam('iso'));
            
            document.getElementById('btn-reset').addEventListener('click', () => {
                oControls.target.set(0,0,0);
                perspCamera.position.set(modelMaxDim*1.5, modelMaxDim*1.5, modelMaxDim*1.5);
                oControls.update();
            });

            document.getElementById('btn-vr').addEventListener('click', () => {
                const b = document.getElementById('VRButton');
                if(b) b.click(); else showToast("VR Not Available");
            });

            document.getElementById('btn-help').addEventListener('click', () => document.getElementById('help-modal').style.display = 'flex');
            document.getElementById('btn-capture').addEventListener('click', () => {
                renderer.render(scene, activeCamera);
                const link = document.createElement('a'); link.download = 'capture.png';
                link.href = renderer.domElement.toDataURL('image/png'); link.click();
            });

            // Side Panel Controls
            const bindClick = (id, fn) => { const el = document.getElementById(id); if(el) el.addEventListener('click', fn); };
            bindClick('bg-sky', () => setBG('sky')); bindClick('bg-solid', () => setBG('solid')); bindClick('bg-hdr', () => setBG('hdr'));
            document.getElementById('bg-color-val').addEventListener('input', (e) => { bgColor.set(e.target.value); if(state.bg==='solid') scene.background=bgColor; });
            document.getElementById('toon-weight').addEventListener('input', (e) => {
                if(model) { const v = parseFloat(e.target.value); model.traverse(c=>{ if(c.userData.isEdge) { c.visible=v>0; c.material.opacity=Math.min(v/2,1); } }); }
            });

            bindClick('cut-toggle', (e) => { 
                state.cutEnabled = !state.cutEnabled; renderer.localClippingEnabled = state.cutEnabled; 
                e.target.classList.toggle('active'); e.target.innerText = state.cutEnabled ? 'ON' : 'OFF'; 
            });
            
            const setAxis = (ax) => { clipAxis = ax; ['axis-x','axis-y','axis-z'].forEach(id => document.getElementById(id).classList.toggle('active', id===`axis-${ax}`)); updateClipPlane(document.getElementById('cut-slider').value); };
            bindClick('axis-x', ()=>setAxis('x')); bindClick('axis-y', ()=>setAxis('y')); bindClick('axis-z', ()=>setAxis('z'));
            bindClick('axis-flip', () => { clipNegate = !clipNegate; updateClipPlane(document.getElementById('cut-slider').value); });
            document.getElementById('cut-slider').addEventListener('input', (e)=>updateClipPlane(e.target.value));

            // AI
            bindClick('btn-ai-analyze', getAIAnalysis);
            bindClick('btn-ai-tts', playAudioGuide);
        }

        // --- Render Loop ---
        function animate() {
            renderer.setAnimationLoop(() => {
                if(renderer.xr.isPresenting) {
                    handleVRInput();
                } else {
                    if(state.cam === 'iso' || isMobile || !document.pointerLockElement) {
                        oControls.update();
                    }
                    if(document.pointerLockElement) {
                        const delta = 0.016;
                        const speed = (state.cam === 'walk' ? 12 : 20) * speedMult;
                        const lookDir = new THREE.Vector3(); perspCamera.getWorldDirection(lookDir);
                        const forward = lookDir.clone(); if(state.cam==='walk') forward.y=0; forward.normalize();
                        const right = new THREE.Vector3().crossVectors(forward, perspCamera.up).normalize();
                        const moveVec = new THREE.Vector3();
                        if(move.f) moveVec.addScaledVector(forward, speed*delta); if(move.b) moveVec.addScaledVector(forward, -speed*delta);
                        if(move.l) moveVec.addScaledVector(right, -speed*delta); if(move.r) moveVec.addScaledVector(right, speed*delta);
                        
                        const oldPos = perspCamera.position.clone();
                        if(state.cam === 'fly') {
                            if(move.u) moveVec.y += speed*delta; if(move.d) moveVec.y -= speed*delta;
                            perspCamera.position.add(moveVec);
                        } else {
                            perspCamera.position.x += moveVec.x; perspCamera.position.z += moveVec.z;
                            velocity.y -= 19.6 * delta; perspCamera.position.y += velocity.y * delta;
                            raycaster.set(new THREE.Vector3(perspCamera.position.x, oldPos.y + 1, perspCamera.position.z), new THREE.Vector3(0,-1,0));
                            const hits = raycaster.intersectObjects(modelGroup.children, true);
                            if(hits.length > 0) {
                                const targetY = hits[0].point.y + 1.7;
                                if(Math.abs(targetY - perspCamera.position.y) < 2.5) {
                                    perspCamera.position.y = THREE.MathUtils.lerp(perspCamera.position.y, targetY, 0.15);
                                    velocity.y = 0; isGrounded = true;
                                } else if(targetY > perspCamera.position.y) {
                                    perspCamera.position.copy(oldPos);
                                }
                            }
                        }
                    }
                }
                renderer.render(scene, activeCamera);
            });
        }

        // --- Helpers ---
        function setBG(type) { state.bg = type; ['bg-sky','bg-solid','bg-hdr'].forEach(id => document.getElementById(id).classList.toggle('active', id===`bg-${type}`)); document.getElementById('solid-picker-row').style.display = type==='solid'?'flex':'none'; document.getElementById('hdr-upload-row').style.display = type==='hdr'?'flex':'none'; if(type==='sky'){scene.background=skyColor; scene.environment=envTexture;} else if(type==='solid'){scene.background=bgColor; scene.environment=null;} else {scene.background=envTexture; scene.environment=envTexture;} }
        function toggleMode(mode) { state.mode = mode; document.getElementById('mode-render').classList.toggle('active', mode==='render'); document.getElementById('mode-white').classList.toggle('active', mode!=='render'); if(mode==='white'){setBG(state.bg); ambientLight.intensity=1.2;} else {scene.background=new THREE.Color(0xffffff); ambientLight.intensity=2.0;} if(model) model.traverse(c=>{ if(c.isMesh) { c.material = mode==='render' ? originalMaterials.get(c.uuid) : new THREE.MeshBasicMaterial({color:0xffffff, side:2}); applyClipping(c.material); c.children.forEach(ch=>{if(ch.userData.isEdge) ch.visible=mode==='white'&&document.getElementById('toon-weight').value>0;}); } }); }
        function setupEvents() {
            window.addEventListener('resize', () => { renderer.setSize(window.innerWidth, window.innerHeight); perspCamera.aspect = window.innerWidth/window.innerHeight; perspCamera.updateProjectionMatrix(); });
            document.addEventListener('keydown', e => { switch(e.code) { case 'KeyW': move.f=1; break; case 'KeyS': move.b=1; break; case 'KeyA': move.l=1; break; case 'KeyD': move.r=1; break; case 'KeyE': move.u=1; break; case 'KeyQ': move.d=1; break; case 'ShiftLeft': speedMult=2; break; } });
            document.addEventListener('keyup', e => { switch(e.code) { case 'KeyW': move.f=0; break; case 'KeyS': move.b=0; break; case 'KeyA': move.l=0; break; case 'KeyD': move.r=0; break; case 'KeyE': move.u=0; break; case 'KeyQ': move.d=0; break; case 'ShiftLeft': speedMult=1; break; } });
            document.addEventListener('mousedown', (e) => { if(!isMobile && document.getElementById('landing-page').style.display === 'none' && !e.target.closest('button, .panel, input')) { isLockPending=true; pControls.lock(); } });
        }
        function makePanelsDraggable() { document.querySelectorAll('.panel').forEach(p => { const h=p.querySelector('.panel-header'); let isD=false, sx, sy, il, it; h.onmousedown=(e)=>{ isD=true; sx=e.clientX; sy=e.clientY; il=p.offsetLeft; it=p.offsetTop; document.onmousemove=(e)=>{ if(isD) { p.style.left=(il+e.clientX-sx)+'px'; p.style.top=(it+e.clientY-sy)+'px'; } }; document.onmouseup=()=>{ isD=false; document.onmousemove=null; }; }; }); }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 3000); }
        
        function handleVRInput() {
            const session = renderer.xr.getSession(); if(!session) return;
            for(const source of session.inputSources) {
                if(source.handedness === 'right' && source.gamepad) {
                    const axes = source.gamepad.axes; const buttons = source.gamepad.buttons;
                    const headDir = new THREE.Vector3(); renderer.xr.getCamera(perspCamera).getWorldDirection(headDir);
                    const sideDir = new THREE.Vector3().crossVectors(headDir, new THREE.Vector3(0,1,0)).normalize();
                    const moveDir = headDir.clone().multiplyScalar(-axes[3]).add(sideDir.clone().multiplyScalar(axes[2]));
                    moveDir.y = 0; cameraRig.position.add(moveDir.multiplyScalar(0.1));
                    if(buttons[5].pressed) switchCam(state.cam==='fly'?'walk':'fly');
                    if(buttons[0].pressed) {
                        tempMatrix.identity().extractRotation(controllerR.matrixWorld);
                        raycaster.ray.origin.setFromMatrixPosition(controllerR.matrixWorld);
                        raycaster.ray.direction.set(0,0,-1).applyMatrix4(tempMatrix);
                        const hits = raycaster.intersectObjects(modelGroup.children, true);
                        if(hits.length>0) cameraRig.position.copy(hits[0].point);
                    }
                }
            }
        }
        
        // AI Utils
        async function fetchWithRetry(url, options) { try { const r=await fetch(url, options); if(r.ok) return await r.json(); } catch(e){} return null; }
        async function getAIAnalysis() { if(!model) return; document.getElementById('btn-ai-analyze').innerText="..."; try { renderer.render(scene, activeCamera); const b64 = renderer.domElement.toDataURL('image/png').split(',')[1]; const p = "Analyze this architecture. 2 sentences Korean."; const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:p},{inlineData:{mimeType:"image/png", data:b64}}]}]})}); lastAIAnalysis = res?.candidates?.[0]?.content?.parts?.[0]?.text || "Error"; document.getElementById('ai-response').innerText = lastAIAnalysis; document.getElementById('btn-ai-tts').style.display='block'; } catch(e){} finally { document.getElementById('btn-ai-analyze').innerText="ANALYZE"; } }
        async function playAudioGuide() { if(!lastAIAnalysis) return; try { const res = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:lastAIAnalysis}]}], generationConfig:{responseModalities:["AUDIO"], speechConfig:{voiceConfig:{prebuiltVoiceConfig:{voiceName:"Aoede"}}}}, model:"gemini-2.5-flash-preview-tts"})}); const blob = pcmToWav(res.candidates[0].content.parts[0].inlineData.data, 24000); new Audio(URL.createObjectURL(blob)).play(); } catch(e){} }
    </script>
</body>
</html>
