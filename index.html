<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCHI-STUDIO | Pro Workspace</title>
    <style>
        :root {
            --apple-purple: #AF52DE;
            --apple-gray: #8E8E93;
            --bg-glass: rgba(255, 255, 255, 0.75);
            --bg-glass-dark: rgba(255, 255, 255, 0.92);
            --border-light: rgba(0, 0, 0, 0.08);
            --shadow-premium: 0 12px 40px rgba(0, 0, 0, 0.12);
            --font-main: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
        }

        body { 
            margin: 0; overflow: hidden; background-color: #f5f5f7; 
            font-family: var(--font-main); color: #1d1d1f; 
            user-select: none; -webkit-user-select: none; touch-action: none;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Landing Page --- */
        #landing-page {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: radial-gradient(circle at center, #ffffff 0%, #f2f2f7 100%);
            z-index: 2000; gap: 40px;
        }
        
        .studio-title { text-align: center; }
        .studio-title h1 { 
            margin: 0; font-size: 38px; font-weight: 800; letter-spacing: -0.04em; 
            background: linear-gradient(180deg, #1d1d1f 0%, #636366 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .studio-title p { margin-top: 10px; color: var(--apple-purple); font-size: 13px; letter-spacing: 0.2em; font-weight: 700; text-transform: uppercase; }

        .option-container { display: flex; gap: 24px; flex-wrap: wrap; justify-content: center; }
        .upload-card {
            background: white; border-radius: 32px; padding: 36px; width: 200px;
            text-align: center; cursor: pointer; transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid var(--border-light); box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        }
        .upload-card:hover { transform: translateY(-8px); box-shadow: var(--shadow-premium); border-color: var(--apple-purple); }
        .upload-card:active { transform: scale(0.96); }
        .upload-card svg { width: 40px; height: 40px; margin-bottom: 20px; color: var(--apple-purple); }
        .upload-card h3 { margin: 0; font-size: 17px; font-weight: 600; }

        /* --- UI Panels --- */
        .panel {
            position: absolute; left: 24px; width: 280px;
            background: var(--bg-glass); backdrop-filter: blur(40px) saturate(180%);
            -webkit-backdrop-filter: blur(40px) saturate(180%);
            border-radius: 24px; box-shadow: var(--shadow-premium);
            border: 1px solid rgba(255,255,255,0.6);
            display: flex; flex-direction: column; z-index: 100;
            transition: transform 0.3s ease;
        }
        .panel-header {
            padding: 18px 24px; cursor: move; display: flex; justify-content: space-between; align-items: center;
            font-weight: 800; font-size: 11px; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.6;
        }
        .panel-content { padding: 0 24px 24px 24px; display: flex; flex-direction: column; gap: 20px; }
        .panel.minimized .panel-content { display: none; }
        
        #env-panel { top: 100px; }
        #cut-panel { top: 460px; }

        /* --- Top Bar --- */
        #top-bar { 
            position: absolute; top: 24px; left: 50%; transform: translateX(-50%); 
            display: flex; align-items: center; gap: 4px; padding: 6px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
            border-radius: 20px; z-index: 1000; box-shadow: var(--shadow-premium);
            border: 1px solid var(--border-light);
            max-width: 95vw; overflow-x: auto;
        }
        #top-bar::-webkit-scrollbar { display: none; }

        button {
            display: inline-flex; align-items: center; gap: 6px;
            background: transparent; border: none; color: #1d1d1f; padding: 10px 14px; 
            border-radius: 14px; cursor: pointer; font-size: 12px; font-weight: 700;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        button svg { width: 16px; height: 16px; opacity: 0.8; }
        button:hover { background: rgba(0,0,0,0.05); }
        button:active { transform: scale(0.94); }
        
        button.active { background: var(--apple-purple); color: #fff !important; }
        button.active svg { filter: brightness(0) invert(1); opacity: 1; }

        .divider { width: 1px; height: 16px; background: rgba(0,0,0,0.1); margin: 0 6px; flex-shrink: 0; }

        /* --- D-Pad --- */
        #mobile-dpad {
            display: none; position: absolute; left: 24px; bottom: 40px;
            z-index: 1000; grid-template-areas: "up-e up up-e" "left . right" "down-q down down-q"; gap: 10px;
        }
        .dbtn {
            width: 56px; height: 56px; background: white; border-radius: 20px;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1); border: 1px solid var(--border-light);
            color: #1d1d1f; cursor: pointer;
        }
        .dbtn.v-btn { font-weight: 900; color: var(--apple-purple); }

        #mobile-menu-btn { 
            display: none; width:56px; height:56px; border-radius:20px; 
            position: absolute; bottom: 40px; right: 24px; z-index: 1001; 
            background: white; border: 1px solid var(--border-light); 
            box-shadow: 0 8px 24px rgba(0,0,0,0.1); justify-content: center; align-items: center;
        }

        /* --- Controls --- */
        input[type=range] { -webkit-appearance: none; width: 100%; height: 4px; background: rgba(0,0,0,0.08); border-radius: 2px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: white; border: 0.5px solid rgba(0,0,0,0.15); border-radius: 50%; box-shadow: 0 2px 6px rgba(0,0,0,0.1); cursor: pointer; }

        .row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .label { color: #86868b; font-size: 11px; text-transform: uppercase; letter-spacing: 0.08em; font-weight: 700; }
        .btn-group-full { display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .row-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; }

        #copyright {
            position: absolute; bottom: 12px; width: 100%; text-align: center;
            font-size: 9px; color: rgba(0,0,0,0.15); letter-spacing: 0.1em; font-weight: 700; pointer-events: none;
        }

        #toast {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.85); color: white; padding: 12px 24px; border-radius: 20px;
            opacity: 0; transition: all 0.4s; font-size: 13px; z-index: 3000; text-align: center;
        }

        #VRButton { display: none !important; }

        @media (max-width: 768px) {
            .panel { display: none; }
            #mobile-menu-btn { display: flex; }
            #mobile-dpad.active { display: grid; }
            .upload-card { width: 85vw; padding: 30px; }
        }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="landing-page">
        <div class="studio-title">
            <h1>ARCHI-STUDIO</h1>
            <p>ADVANCED DESIGN WORKSPACE</p>
        </div>
        <div class="option-container">
            <div class="upload-card" id="btn-load-project">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                <h3>LOAD PROJECT</h3>
                <p>Repository 내 로컬 모델 로드<br>(model.glb)</p>
            </div>
            <div class="upload-card" onclick="document.getElementById('file-input').click()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                <h3>BROWSE FILES</h3>
                <p>내 기기에서 직접 모델 선택</p>
                <input type="file" id="file-input" accept=".glb,.gltf" style="display:none;">
            </div>
        </div>
        <div id="loading-status" style="display:none; color:var(--apple-purple); font-weight:700; font-size:12px; margin-top: 20px;">INITIALIZING WORKSPACE...</div>
    </div>

    <div id="ui-layer" style="display:none;">
        <div id="crosshair"></div>
        <button id="mobile-menu-btn" onclick="toggleMobileSettings()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>

        <div id="top-bar">
            <button id="mode-render" class="active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/><path d="M2 12h20"/></svg>RENDER</button>
            <button id="mode-white"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>WHITE</button>
            <div class="divider"></div>
            <button id="cam-fly" class="active"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>FLY</button>
            <button id="cam-walk"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 4v2"/><path d="M17 4v2"/><path d="M10 10h9v4a2 2 0 0 1-2 2h-1"/><path d="M14 14l-3 6"/><path d="M14 14l3 6"/></svg>WALK</button>
            <button id="cam-iso"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 16.09v-8.18a1.56 1.56 0 0 0-.78-1.35l-7.44-4.29a1.56 1.56 0 0 0-1.56 0L3.78 6.56A1.56 1.56 0 0 0 3 7.91v8.18a1.56 1.56 0 0 0 .78 1.35l7.44 4.29a1.56 1.56 0 0 0 1.56 0l7.44-4.29a1.56 1.56 0 0 0 .78-1.35z"/><path d="M12 22.08V12"/><path d="M3.11 8l8.89 5.13L20.89 8"/><path d="M12 12l8.89-5.13"/></svg>ISO</button>
            <div class="divider"></div>
            <button id="btn-reset"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>RESET</button>
            <button id="btn-gyro"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><path d="M12 6v12"/><path d="M6 12h12"/></svg>GYRO</button>
            <button id="btn-vr" style="background:#1d1d1f; color:#fff;"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M12 12h.01"/></svg>VR VIEW</button>
            <button id="btn-capture" style="color:var(--apple-purple)"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>CAPTURE</button>
        </div>

        <div id="mobile-dpad">
            <div class="dbtn v-btn" style="grid-area: up-e;">E</div>
            <div class="dbtn" style="grid-area: up;">↑</div>
            <div class="dbtn" style="grid-area: left;">←</div>
            <div class="dbtn" style="grid-area: right;">→</div>
            <div class="dbtn v-btn" style="grid-area: down-q;">Q</div>
            <div class="dbtn" style="grid-area: down;">↓</div>
        </div>

        <div id="env-panel" class="panel">
            <div class="panel-header">Environment <button class="toggle-btn">－</button></div>
            <div class="panel-content">
                <div class="btn-group-full">
                    <span class="label">Atmosphere Type</span>
                    <div class="row-grid">
                        <button id="bg-sky" class="active">SKY</button>
                        <button id="bg-solid">SOLID</button>
                        <button id="bg-hdr">HDR</button>
                    </div>
                </div>
                <div id="solid-picker-row" style="display:none;" class="row">
                    <span class="label">Color Select</span>
                    <input type="color" id="bg-color-val" value="#ffffff" style="border:none;background:none;width:32px;height:32px;cursor:pointer;">
                </div>
                <div id="hdr-upload-row" style="display:none;" class="row">
                    <button onclick="document.getElementById('hdr-input').click()" style="width:100%;background:rgba(0,0,0,0.04); justify-content:center;">UPLOAD .HDR</button>
                    <input type="file" id="hdr-input" accept=".hdr,.exr" style="display:none;">
                </div>
                <div class="row">
                    <span class="label">Line Weight (Toon)</span>
                    <input type="range" id="toon-weight" min="0" max="5" step="0.1" value="1">
                </div>
            </div>
        </div>

        <div id="cut-panel" class="panel">
            <div class="panel-header">Analysis <button class="toggle-btn">－</button></div>
            <div class="panel-content">
                <div class="row" style="justify-content:center; gap:12px; background:rgba(0,0,0,0.03); padding:10px; border-radius:14px;">
                    <span class="label" style="margin:0;">Clipping</span>
                    <button id="cut-toggle" class="active" style="padding:6px 12px; min-width:80px; justify-content:center;">ENABLED</button>
                </div>
                <div class="btn-group-full">
                    <div class="row-grid">
                        <button id="axis-x" class="axis-btn">X-AXIS</button>
                        <button id="axis-y" class="axis-btn active">Y-AXIS</button>
                        <button id="axis-z" class="axis-btn">Z-AXIS</button>
                    </div>
                    <button id="axis-flip" style="width:100%; background:rgba(175,82,222,0.1); color:var(--apple-purple); justify-content:center; padding:12px;">REVERSE DIRECTION</button>
                </div>
                <div class="row"><span class="label">Plane Offset</span><input type="range" id="cut-slider" min="-100" max="100" value="100"></div>
            </div>
        </div>

        <div id="copyright">COPYRIGHT BY KIL ARCHITECTURE 2026</div>
        <div id="toast">Message</div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js';
        import { VRButton } from 'three/addons/webxr/VRButton.js';

        let scene, renderer, perspCamera, orthoCamera, activeCamera, pControls, oControls;
        let cameraRig, model = null, modelGroup = new THREE.Group();
        let originalMaterials = new Map(), envTexture, skyColor = new THREE.Color(0x87CEEB), bgColor = new THREE.Color(0xffffff);
        let sunLight, hemiLight, ambientLight, initialCamPos = new THREE.Vector3(30, 30, 30);
        
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        const clipPlane = new THREE.Plane(new THREE.Vector3(0, -1, 0), 100);
        let clipAxis = 'y', clipNegate = true;
        const state = { mode: 'render', cam: 'fly', bg: 'sky', cutEnabled: true, gyro: false };
        const velocity = new THREE.Vector3(), move = { f:0, b:0, l:0, r:0, u:0, d:0 };
        let speedMult = 1, isGrounded = false, controllerRight, raycaster = new THREE.Raycaster();

        init();
        animate();

        function init() {
            scene = new THREE.Scene(); scene.background = skyColor; scene.add(modelGroup);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
            renderer.setSize(window.innerWidth, window.innerHeight); renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true; renderer.localClippingEnabled = true;
            renderer.toneMapping = THREE.ReinhardToneMapping; renderer.toneMappingExposure = 1.3;
            renderer.xr.enabled = true; document.body.appendChild(renderer.domElement);

            cameraRig = new THREE.Group(); scene.add(cameraRig);
            const pmremGenerator = new THREE.PMREMGenerator(renderer);
            envTexture = pmremGenerator.fromScene(new RoomEnvironment(), 0.04).texture;
            scene.environment = envTexture;

            const aspect = window.innerWidth / window.innerHeight;
            perspCamera = new THREE.PerspectiveCamera(60, aspect, 0.1, 10000); 
            perspCamera.position.copy(initialCamPos); cameraRig.add(perspCamera); 

            orthoCamera = new THREE.OrthographicCamera(-30*aspect, 30*aspect, 30, -30, 0.1, 10000);
            orthoCamera.position.set(50, 50, 50); orthoCamera.lookAt(0, 0, 0);
            activeCamera = perspCamera;

            ambientLight = new THREE.AmbientLight(0xffffff, 0.6); scene.add(ambientLight);
            hemiLight = new THREE.HemisphereLight(0xffffff, 0xffffff, 1.0); scene.add(hemiLight);
            sunLight = new THREE.DirectionalLight(0xffffff, 3.0); sunLight.position.set(40, 60, 40); sunLight.castShadow = true;
            sunLight.shadow.mapSize.set(2048, 2048); scene.add(sunLight);

            const vrBtn = VRButton.createButton(renderer); vrBtn.id = "VRButton"; document.body.appendChild(vrBtn);

            controllerRight = renderer.xr.getController(1);
            controllerRight.addEventListener('selectend', () => { 
                if (teleportMarker && teleportMarker.visible) { cameraRig.position.set(teleportMarker.position.x, cameraRig.position.y, teleportMarker.position.z); teleportMarker.visible = false; }
            });
            cameraRig.add(controllerRight);

            pControls = new PointerLockControls(perspCamera, document.body);
            oControls = new OrbitControls(perspCamera, renderer.domElement); oControls.enableDamping = true;

            setupEvents(); setupUI(); setupMobileDpad(); makePanelsDraggable();
        }

        function loadGLB(url) {
            let finalUrl = url;
            if (!url.startsWith('blob:') && !url.startsWith('http')) {
                const base = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                finalUrl = new URL(url, base).href;
            }
            document.getElementById('loading-status').style.display = 'block';
            new GLTFLoader().load(finalUrl, (gltf) => {
                onModelLoaded(gltf);
            }, undefined, () => {
                new GLTFLoader().load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/SheenChair.glb', (gltf) => {
                    onModelLoaded(gltf);
                    showToast("샘플 모델 로드됨");
                });
            });
        }

        function onModelLoaded(gltf) {
            document.getElementById('loading-status').style.display = 'none';
            if(model) modelGroup.remove(model); model = gltf.scene;
            const box = new THREE.Box3().setFromObject(model); 
            const center = box.getCenter(new THREE.Vector3()); 
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            model.position.sub(center); 
            model.traverse(c => {
                if(c.isMesh) {
                    c.castShadow = true; c.receiveShadow = true; originalMaterials.set(c.uuid, c.material); applyClipping(c.material);
                    const edges = new THREE.EdgesGeometry(c.geometry, 25);
                    const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ 
                        color: 0x000000, transparent: true, opacity: 0.8, polygonOffset: true, polygonOffsetFactor: 1, polygonOffsetUnits: 1 
                    }));
                    line.material.clippingPlanes = [clipPlane]; line.visible = false; line.userData.isEdge = true; c.add(line); 
                }
            });
            modelGroup.add(model);
            const slider = document.getElementById('cut-slider'); slider.min = -maxDim; slider.max = maxDim; slider.value = maxDim;
            updateClipPlane(slider.value);
            document.getElementById('landing-page').style.display = 'none'; document.getElementById('ui-layer').style.display = 'block';
            initialCamPos.set(maxDim * 1.5, maxDim * 1.5, maxDim * 1.5);
            perspCamera.position.copy(initialCamPos); perspCamera.lookAt(0,0,0); oControls.target.set(0,0,0);
            showToast("Workplace Ready");
        }

        function applyClipping(m) { if(Array.isArray(m)) m.forEach(x => x.clippingPlanes = [clipPlane]); else m.clippingPlanes = [clipPlane]; }
        function updateClipPlane(val) { const v = parseFloat(val); clipPlane.constant = clipNegate ? v : -v; clipPlane.normal.set(0,0,0); if(clipAxis === 'x') clipPlane.normal.x = clipNegate ? -1 : 1; if(clipAxis === 'y') clipPlane.normal.y = clipNegate ? -1 : 1; if(clipAxis === 'z') clipPlane.normal.z = clipNegate ? -1 : 1; }

        function toggleMode(mode) {
            state.mode = mode; const isRender = mode === 'render';
            document.getElementById('mode-render').classList.toggle('active', isRender);
            document.getElementById('mode-white').classList.toggle('active', !isRender);
            if (!isRender) { scene.background = bgColor; scene.environment = null; ambientLight.intensity = 1.8; hemiLight.intensity = 2.0; }
            else { updateBackground(); ambientLight.intensity = 0.6; hemiLight.intensity = 1.0; }
            if(!model) return;
            const whiteMat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 1, metalness: 0, side: THREE.DoubleSide });
            model.traverse(c => { if(c.isMesh) { c.material = isRender ? originalMaterials.get(c.uuid) : whiteMat.clone(); applyClipping(c.material); c.children.forEach(ch => { if(ch.userData.isEdge) ch.visible = !isRender; }); } });
        }

        function updateBackground() {
            if (state.bg === 'sky') { scene.background = skyColor; scene.environment = envTexture; }
            else if (state.bg === 'solid') { scene.background = bgColor; scene.environment = null; }
            else { scene.background = envTexture; scene.environment = envTexture; }
        }

        function setupEvents() {
            window.addEventListener('resize', () => { renderer.setSize(window.innerWidth, window.innerHeight); perspCamera.aspect = window.innerWidth/window.innerHeight; perspCamera.updateProjectionMatrix(); });
            document.addEventListener('keydown', e => { switch(e.code) { case 'KeyW': move.f = 1; break; case 'KeyS': move.b = 1; break; case 'KeyA': move.l = 1; break; case 'KeyD': move.r = 1; break; case 'KeyE': move.u = 1; break; case 'KeyQ': move.d = 1; break; case 'ShiftLeft': speedMult = 2.5; break; case 'Space': if(state.cam === 'walk' && isGrounded) velocity.y = 8; break; } });
            document.addEventListener('keyup', e => { switch(e.code) { case 'KeyW': move.f = 0; break; case 'KeyS': move.b = 0; break; case 'KeyA': move.l = 0; break; case 'KeyD': move.r = 0; break; case 'KeyE': move.u = 0; break; case 'KeyQ': move.d = 0; break; case 'ShiftLeft': speedMult = 1; break; } });
        }

        function setupUI() {
            const bindClick = (id, fn) => { const el = document.getElementById(id); if(el) el.onclick = fn; };
            const bindInput = (id, fn) => { const el = document.getElementById(id); if(el) el.oninput = fn; };

            bindClick('btn-load-project', () => loadGLB('model.glb'));
            document.getElementById('file-input').onchange = (e) => { if(e.target.files[0]) loadGLB(URL.createObjectURL(e.target.files[0])); };
            bindClick('mode-render', () => toggleMode('render')); bindClick('mode-white', () => toggleMode('white'));
            bindClick('cam-fly', () => switchCam('fly')); bindClick('cam-walk', () => switchCam('walk')); bindClick('cam-iso', () => switchCam('iso'));
            bindClick('btn-reset', () => { cameraRig.position.set(0,0,0); perspCamera.position.copy(initialCamPos); oControls.target.set(0,0,0); velocity.set(0,0,0); showToast("시점 리셋"); });
            bindClick('btn-gyro', () => { state.gyro = !state.gyro; document.getElementById('btn-gyro').classList.toggle('active', state.gyro); oControls.enabled = !state.gyro; });
            bindClick('btn-vr', () => document.getElementById('VRButton').click());
            bindClick('btn-capture', () => { renderer.render(scene, activeCamera); const link = document.createElement('a'); link.download = 'capture.png'; link.href = renderer.domElement.toDataURL('image/png'); link.click(); });
            
            // Background Selection
            const setBG = (type) => { 
                state.bg = type; 
                ['bg-sky', 'bg-solid', 'bg-hdr'].forEach(id => document.getElementById(id).classList.toggle('active', id === `bg-${type}`));
                document.getElementById('solid-picker-row').style.display = type === 'solid' ? 'flex' : 'none';
                document.getElementById('hdr-upload-row').style.display = type === 'hdr' ? 'flex' : 'none';
                updateBackground();
            };
            bindClick('bg-sky', () => setBG('sky')); bindClick('bg-solid', () => setBG('solid')); bindClick('bg-hdr', () => setBG('hdr'));
            bindInput('bg-color-val', (e) => { bgColor.set(e.target.value); updateBackground(); });
            
            // HDRI Upload
            document.getElementById('hdr-input').onchange = (e) => {
                if(e.target.files[0]) {
                    new RGBELoader().load(URL.createObjectURL(e.target.files[0]), (tex) => {
                        tex.mapping = THREE.EquirectangularReflectionMapping; envTexture = tex; updateBackground(); showToast("HDR Applied");
                    });
                }
            };

            // Toon Weight
            bindInput('toon-weight', (e) => {
                const w = parseFloat(e.target.value);
                if(model) model.traverse(c => { if(c.userData.isEdge) { c.visible = w > 0; c.material.opacity = Math.min(w, 1); } });
            });

            bindClick('cut-toggle', (e) => { state.cutEnabled = !state.cutEnabled; renderer.localClippingEnabled = state.cutEnabled; e.target.classList.toggle('active'); });
            const setAxis = (ax) => { clipAxis = ax; ['axis-x','axis-y','axis-z'].forEach(id => document.getElementById(id).classList.toggle('active', id === `axis-${ax}`)); updateClipPlane(document.getElementById('cut-slider').value); };
            bindClick('axis-x', () => setAxis('x')); bindClick('axis-y', () => setAxis('y')); bindClick('axis-z', () => setAxis('z')); 
            bindClick('axis-flip', () => { clipNegate = !clipNegate; updateClipPlane(document.getElementById('cut-slider').value); });
            bindInput('cut-slider', (e) => updateClipPlane(e.target.value));
        }

        function switchCam(mode) {
            state.cam = mode;
            ['cam-fly','cam-walk','cam-iso'].forEach(id => document.getElementById(id).classList.toggle('active', id === `cam-${mode}`));
            const isIso = mode === 'iso';
            document.getElementById('mobile-dpad').classList.toggle('active', !isIso);
            if(isIso) { activeCamera = orthoCamera; oControls.object = orthoCamera; oControls.enabled = true; }
            else { activeCamera = perspCamera; oControls.object = perspCamera; oControls.enabled = isMobile; }
            showToast(`Navigation: ${mode.toUpperCase()}`);
        }

        function setupMobileDpad() {
            const bind = (id, key) => { const el = document.getElementById(id); if(el) { 
                el.addEventListener('touchstart', (e) => { e.preventDefault(); move[key] = 1; }); 
                el.addEventListener('touchend', (e) => { e.preventDefault(); move[key] = 0; }); 
            } };
            bind('d-up', 'f'); bind('d-down', 'b'); bind('d-left', 'l'); bind('d-right', 'r'); bind('d-up-e', 'u'); bind('d-down-q', 'd');
        }

        function makePanelsDraggable() {
            document.querySelectorAll('.panel').forEach(p => {
                const h = p.querySelector('.panel-header'); const t = p.querySelector('.toggle-btn');
                t.onclick = (e) => { e.stopPropagation(); p.classList.toggle('minimized'); t.innerText = p.classList.contains('minimized')?'＋':'－'; };
                let isD = false, sx, sy, il, it;
                h.onmousedown = (e) => { isD = true; sx = e.clientX; sy = e.clientY; il = p.offsetLeft; it = p.offsetTop;
                    document.onmousemove = (e) => { if(!isD) return; p.style.left = (il + e.clientX - sx) + 'px'; p.style.top = (it + e.clientY - sy) + 'px'; };
                    document.onmouseup = () => { isD = false; document.onmousemove = null; };
                };
            });
        }

        function animate() {
            renderer.setAnimationLoop(() => {
                if(!renderer.xr.isPresenting) {
                    if(oControls.enabled && !state.gyro) oControls.update();
                    if(state.cam === 'fly' || state.cam === 'walk') {
                        const delta = 0.016, speed = (state.cam === 'walk' ? 35 : 55) * speedMult;
                        const forward = new THREE.Vector3(0,0,-1).applyQuaternion(perspCamera.quaternion);
                        const right = new THREE.Vector3(1,0,0).applyQuaternion(perspCamera.quaternion);
                        if(state.cam === 'walk') { forward.y = 0; right.y = 0; forward.normalize(); right.normalize(); }
                        
                        velocity.x -= velocity.x * 10 * delta; velocity.z -= velocity.z * 10 * delta; velocity.y -= velocity.y * 5 * delta;
                        const moveDir = new THREE.Vector3(move.r - move.l, 0, move.b - move.f).normalize();
                        if(move.f||move.b||move.l||move.r) { 
                            // 방향 보정: -moveDir.z 사용 (전진 방향)
                            velocity.z -= moveDir.z * speed * delta; velocity.x -= moveDir.x * speed * delta; 
                        }
                        
                        perspCamera.position.addScaledVector(forward, -velocity.z * delta);
                        perspCamera.position.addScaledVector(right, -velocity.x * delta);
                        
                        if(move.u) velocity.y += speed * delta; if(move.d) velocity.y -= speed * delta;
                        if(state.cam === 'walk') {
                            if(!move.u && !move.d) velocity.y -= 9.8 * 3.5 * delta;
                            raycaster.set(perspCamera.position, new THREE.Vector3(0,-1,0));
                            const hits = raycaster.intersectObjects(modelGroup.children, true);
                            if (hits.length > 0) {
                                const targetY = hits[0].point.y + 1.7;
                                if(perspCamera.position.y - targetY < 1.0) {
                                    perspCamera.position.y = THREE.MathUtils.lerp(perspCamera.position.y, targetY, 0.2);
                                    velocity.y = 0; isGrounded = true;
                                } else isGrounded = false;
                            } else isGrounded = false;
                        }
                        perspCamera.position.y += velocity.y * delta;
                    }
                }
                renderer.render(scene, activeCamera);
            });
        }

        window.toggleMobileSettings = () => { const ps = document.querySelectorAll('.panel'); ps.forEach(p => p.style.display = (p.style.display==='none'||p.style.display==='')?'flex':'none'); };
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.opacity = 1; setTimeout(()=>t.style.opacity = 0, 3000); }
    </script>
</body>
</html>
